name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions: {}

env:
  REGISTRY: ghcr.io
  REPO_OWNER: ${{ github.repository_owner }}

jobs:
  check:
    name: Check flake
    runs-on: ubuntu-24.04
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: DeterminateSystems/flake-checker-action@3164002371bc90729c68af0e24d5aacf20d7c9f6 # v12

      - name: Check
        run: nix flake check

      - name: Format Nix
        run: nix fmt -- --check .

      - name: Lint YAML
        run: nix run nixpkgs#yamllint -- --format github --strict .

      - name: Format YAML
        run: nix run nixpkgs#yamlfmt -- -lint .

  build:
    name: Build and Push
    needs:
      - check
    permissions:
      id-token: "write"
      contents: "read"
      packages: "write"
    strategy:
      fail-fast: false
      matrix:
        variant:
          - "nix"
          - "lix"
        build:
          - runner: ubuntu-24.04
            architecture: amd64
          - runner: ubuntu-24.04-arm
            architecture: arm64
    runs-on: ${{ matrix.build.runner }}
    env:
      ARCHITECTURE: ${{ matrix.build.architecture }}
      VARIANT: ${{ matrix.variant }}

    steps:
      - uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
        with:
          use-flakehub: false

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Build
        run: nix build -L ".#${VARIANT}"

      - name: Login
        #if: ${{ github.ref_name == 'main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >-
          nix run nixpkgs#skopeo --
          login "${REGISTRY}"
          --username "${REPO_OWNER}"
          --password "${GH_TOKEN}"

      - name: Push
        #if: ${{ github.ref_name == 'main' }}
        run: >-
          nix run nixpkgs#skopeo --
          copy docker-archive:result
          docker://${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}

      - name: Fetch image digest
        id: digest
        #if: ${{ github.ref_name == 'main' }}
        run: >-
          nix run nixpkgs#skopeo --
          inspect
          --format 'digest={{ .Digest }}'
          docker://${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}
          >> "${GITHUB_OUTPUT}"

      # https://github.com/sigstore/cosign/issues/587
      - name: Copy credentials for cosign
        #if: ${{ github.ref_name == 'main' }}
        run: |
          mkdir -p ~/.docker
          cp -v ${XDG_RUNTIME_DIR}/containers/auth.json ~/.docker/config.json

      - name: Sign image with static key
        #if: ${{ github.ref_name == 'main' }}
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          sign
          --yes
          --key env://COSIGN_PRIVATE_KEY
          -a "repo=${{ github.repository }}"
          -a "workflow=${{ github.workflow }}"
          -a "ref=${{ github.sha }}"
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}@${DIGEST}

      - name: Sign with GitHub OIDC Token
        #if: ${{ github.ref_name == 'main' }}
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          sign
          --yes
          -a "repo=${{ github.repository }}"
          -a "workflow=${{ github.workflow }}"
          -a "ref=${{ github.sha }}"
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}@${DIGEST}

      - name: Verify container image
        #if: ${{ github.ref_name == 'main' }}
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          verify
          --key cosign.pub
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}@${DIGEST}
          #nix run nixpkgs#cosign --
          #verify
          #--certificate-oidc-issuer https://token.actions.githubusercontent.com
          #--certificate-identity-regexp="https://github.com/$REPO"
          #-o text
          #${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}

  merge:
    name: Create and Push Manifest
    if: ${{ github.ref_name == 'main' }}
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        variant: ["nix", "lix"]
    env:
      VARIANT: ${{ matrix.variant }}
    needs:
      - build
    permissions:
      id-token: "write"
      contents: "read"
      packages: "write"
    steps:
      - name: Login to container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Create manifest
        run: |
          docker buildx imagetools create \
            -t ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest \
            ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-amd64 \
            ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-arm64

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest
