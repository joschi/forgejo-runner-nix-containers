name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions: {}

env:
  REGISTRY: ghcr.io
  REPO_OWNER: ${{ github.repository_owner }}

jobs:
  check:
    name: Check flake
    runs-on: ubuntu-24.04
    permissions:
      id-token: "write"
      contents: "read"
    steps:
      - uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: DeterminateSystems/flake-checker-action@3164002371bc90729c68af0e24d5aacf20d7c9f6 # v12

      - name: Check
        run: nix flake check

      - name: Format Nix
        run: nix fmt -- --check .

      - name: Lint YAML
        run: nix run nixpkgs#yamllint -- --format github --strict .

      - name: Format YAML
        run: nix run nixpkgs#yamlfmt -- -lint .

  build:
    name: Build and Push
    needs:
      - check
    permissions:
      id-token: "write"
      contents: "read"
      packages: "write"
    strategy:
      fail-fast: false
      matrix:
        variant:
          - "nix"
          - "lix"
          - "detsys-nix"
        build:
          - runner: ubuntu-24.04
            architecture: amd64
          - runner: ubuntu-24.04-arm
            architecture: arm64
    runs-on: ${{ matrix.build.runner }}
    env:
      ARCHITECTURE: ${{ matrix.build.architecture }}
      VARIANT: ${{ matrix.variant }}

    steps:
      - uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
        with:
          use-flakehub: false

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Build
        run: nix build -L ".#${VARIANT}"

      - name: Login
        if: ${{ github.ref_name == 'main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >-
          nix run nixpkgs#skopeo --
          login "${REGISTRY}"
          --username "${REPO_OWNER}"
          --password "${GH_TOKEN}"

      - name: Push
        if: ${{ github.ref_name == 'main' }}
        run: >-
          nix run nixpkgs#skopeo --
          copy docker-archive:result
          docker://${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-${ARCHITECTURE}

  merge:
    name: Create and Push Manifest
    if: ${{ github.ref_name == 'main' }}
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        variant: ["nix", "lix", "detsys-nix"]
    env:
      VARIANT: ${{ matrix.variant }}
    needs:
      - build
    permissions:
      id-token: "write"
      contents: "read"
      packages: "write"
    steps:
      - uses: DeterminateSystems/nix-installer-action@c5a866b6ab867e88becbed4467b93592bce69f8a # v21

      - uses: DeterminateSystems/magic-nix-cache-action@565684385bcd71bad329742eefe8d12f2e765b39 # v13
        with:
          use-flakehub: false

      # see https://github.com/actions/runner-images/issues/10443
      - run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

      - name: Login
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >-
          nix run nixpkgs#buildah --
          login "${REGISTRY}"
          --username "${REPO_OWNER}"
          --password "${GH_TOKEN}"

      - name: Create manifest
        run: >-
          nix run nixpkgs#buildah --
          manifest create
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-amd64
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest-arm64

      - name: Push manifest
        run: >-
          nix run nixpkgs#buildah --
          manifest push
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest

      - name: Inspect image
        run: >-
          nix run nixpkgs#skopeo --
          inspect
          docker://${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest

      - name: Fetch image digest
        id: digest
        run: >-
          nix run nixpkgs#skopeo --
          inspect
          --format 'digest={{ .Digest }}'
          docker://${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest
          >> "${GITHUB_OUTPUT}"

      # https://github.com/sigstore/cosign/issues/587
      - name: Copy credentials for cosign
        run: |
          mkdir -p ~/.docker
          cp -v ${XDG_RUNTIME_DIR}/containers/auth.json ~/.docker/config.json

      - name: Sign image with static key
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          sign
          --yes
          --recursive
          --key env://COSIGN_PRIVATE_KEY
          -a "repo=${GITHUB_REPOSITORY}"
          -a "workflow=${GITHUB_WORKFLOW}"
          -a "ref=${GITHUB_SHA}"
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest@${DIGEST}

      - name: Sign with GitHub OIDC Token
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          sign
          --yes
          --recursive
          -a "repo=${GITHUB_REPOSITORY}"
          -a "workflow=${GITHUB_WORKFLOW}"
          -a "ref=${GITHUB_SHA}"
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest@${DIGEST}

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Verify image signatures
        env:
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: >-
          nix run nixpkgs#cosign --
          verify
          --key cosign.pub
          ${REGISTRY}/${REPO_OWNER}/forgejo-${VARIANT}:latest@${DIGEST}
